---
output:
  html_document:
    toc: yes
---

<style>h1 {font-size: 15pt;}</style>

# 0. data, functions

```{r}
## r stuff for xshift
## readr::read_csv for speed
## fns

fdl_split <- function(data, group = 'ClusterID', split = 'Group',
                      legend = list(), reset_par = TRUE) {
  sp <- split(data, data[, split])
  gr <- grep(sprintf('\\b%s\\b', group), names(data))
  xr <- range(data[, gr], na.rm = TRUE)
  
  op <- par(oma = c(0,0,0,0))
  if (reset_par)
    on.exit(par(op))
  
  lapply(seq_along(sp), function(ii) {
    x <- sp[[ii]]
    
    fdl(data, group, FALSE, 'grey50', xr)
    par(new = TRUE)
    fdl(x, group, FALSE, NULL, xr, FALSE)
    
    mtext(names(sp)[ii], at = grconvertX(0, 'nfc'),
          adj = -1, line = -2, font = 2L, cex = 1.5)
  })
  
  cc <- c('blue', 'cyan', 'green', 'yellow', 'red')
  nc <- seq_along(cc)
  largs <- list(
    x = 'topright', pch = 16L, title = gsub(':.*', '', group), xpd = NA,
    col = cc,
    legend = sprintf('%.1f', quantile(data[, gr], (nc - 1L) / diff(range(nc))))
  )
  do.call('legend', modifyList(largs, legend))
  
  invisible(NULL)
}

fdl <- function(data, group = 'ClusterID', legend = list(),
                col = NULL, from = NULL, reset_par = TRUE) {
  ## interpolate colors based on continuous values
  interp <- function(x, col, alpha = FALSE, n = 1e5L,
                     fr = NULL, to = 0:1) {
    fr <- if (is.null(fr))
      range(x, na.rm = TRUE) else fr
    to <- to[1:2] * if (alpha) 1 else n
    x  <- (x - fr[1L]) / diff(fr) * diff(to) + to[1L]
    
    if (alpha)
      Vectorize(adjustcolor)(col[1L], alpha.f = x)
    else colorRampPalette(col)(n + 1L)[as.integer(x) + 1L]
  }
  
  var <- if (is.null(group))
    'ClusterID'
  else if (length(var <- grep(group, names(data), value = TRUE)) > 1L)
    grep(sprintf('\\b%s\\b', group), names(data), value = TRUE)
  else if (!length(var))
    'ClusterID'
  else var
  
  data <- data[order(data[, var]), ]
  fvar <- as.factor(data[, var])
  
  colors <- if (!(ok <- nlevels(fvar) < 50L))
    c('blue', 'cyan', 'green', 'yellow', 'red') else 'grey50'
  if (!is.null(col))
    colors <- c('transparent', col)
  nc <- seq_along(colors)
  
  op <- par(mar = c(0, 0, 0, 0))
  if (reset_par)
    on.exit(par(op))
  
  plot(Y ~ X, data, type = 'n', ann = FALSE, axes = FALSE, bty = 'n')
  
  if (is.null(group))
    points(Y ~ X, data, pch = '.', cex = 2,
           col = adjustcolor(colors[1L], alpha.f = 0.5))
  else
    points(Y ~ X, data, pch = '.', cex = 2,
           col = if (ok) fvar else interp(data[, var], colors, fr = from))
  
  if (!identical(legend, FALSE) && !is.null(group)) {
    largs <- list(
      x = 'topright', pch = 16L, title = gsub(':.*', '', var),
      col = if (ok)
        seq_along(levels(fvar)) else colors,
      legend = if (ok)
        levels(fvar) else
          sprintf('%.1f', quantile(data[, var], (nc - 1L) / diff(range(nc))))
    )
    do.call('legend', modifyList(largs, legend))
  }
  
  invisible(NULL)
}

km <- function(data, centers = length(unique(data$ClusterID)),
               spider = TRUE, hull = TRUE, groups = NULL, col = 'grey') {
  suppressPackageStartupMessages(
    require('vegan', character.only = TRUE, quietly = TRUE)
  )
  
  `%||%` <- function(x, y) if (is.null(x)) y else x
  
  set.seed(1)
  xy <- as.matrix(data[, c('X', 'Y')])
  km <- kmeans(xy, centers, 1e5L)
  cl <- factor(km$cluster)
  
  if (spider)
    ordispider(xy, factor(km$cluster, groups %||% levels(cl)),
               label = TRUE, col = adjustcolor(col, alpha.f = 0.1))
  if (hull)
    ordihull(xy, factor(km$cluster, groups %||% levels(cl)),
             lty = 'dashed', col = col)
  
  invisible(km)
}
```

```{r, results='hold', message=FALSE}
## read in fcs data after import (not necessary)
# dat <- as.data.frame(readr::read_csv('data/data.csv'))

## read in cluster data after clustering is complete
clust <- as.data.frame(readr::read_csv('data/cluster.csv'))
clust <- within(clust, {
  Filename <- `File Name`
  Group <- gsub('^(.)|.', '\\U\\1', Filename, perl = TRUE)
})

## read in force-directed layout coordinates after FDL is complete
coords <- as.data.frame(readr::read_delim('data/coords.csv', ';'))

coords <- within(coords, {
  ## data reflected about y-axis on mac but not windows?
  Y <- Y * -1
})


datm <- merge(coords, clust, by = c('Filename', 'EventID'))
```

# 1. Identify cytotoxic T cells (also called CD8+ T cells; they express CD3 and CD8, but not CD4) in all samples.

```{r, fig.width = 10, fig.height = 12}
par(mfrow = c(3,2))
fdl(datm, 'ClusterID', FALSE)
fdl(datm, 'Group')

fdl(datm, 'CD3')
fdl(datm, 'CD8a')
fdl(datm, 'CD4')

fdl(datm, NULL, legend = list(title = 'CD3/CD8+, CD4-'))

## choose groups to highlight manually
# km(datm)
## groups 6, maybe 16, look like CD8+ t-cells

km(datm, groups = c(6, 16), spider = FALSE, col = 'red')
legend('topright', legend = 'CD3/CD8+\nCD4-', col = 'red', lty = 2L)

# fdl(datm, 'PD')

abline(h = grconvertY(1:2 / 3, 'ndc'), v = grconvertX(.5, 'ndc'), xpd = NA)
```

# 2. Determine whether there are differences in expression of PD-1, Tim-3, LAG-3, CTLA-4, ICOS, 4-1BB, OX-40, Ki-67, HLA-DR, and CD38 on CD8+ T cells between patient Groups A and B.

```{r, fig.width=10, fig.height=4}
wh <- c('PD', 'Tim', 'LAG', 'CTLA4', 'ICOS',
        '4-1BB', 'OX40', 'Ki-67', 'HLA', 'CD38')
par(mfrow = c(1,2))
for (ii in wh) {
  fdl_split(datm, ii)
  abline(v = grconvertX(0.5, 'ndc'), xpd = NA)
  box('outer')
}
```

# session

```{r}
sessionInfo()
```
